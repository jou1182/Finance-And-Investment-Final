<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analysis Platform | ŸÖŸÜÿµÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿßŸÑŸä</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
:root {
    --primary-900: #0c1929;
    --primary-800: #1a365d;
    --primary-700: #234681;
    --primary-600: #2c5282;
    --primary-500: #3182ce;
    --primary-400: #4299e1;
    --primary-300: #63b3ed;
    --accent-gold: #d69e2e;
    --accent-gold-light: #ecc94b;
    --bg-primary: #f8fafc;
    --bg-card: #ffffff;
    --text-primary: #1e293b;
    --text-secondary: #475569;
    --text-muted: #94a3b8;
    --text-light: #f1f5f9;
    --border-color: #e2e8f0;
    --border-light: #f1f5f9;
    --positive: #10b981;
    --positive-bg: rgba(16, 185, 129, 0.1);
    --negative: #ef4444;
    --negative-bg: rgba(239, 68, 68, 0.1);
    --warning: #f59e0b;
    --warning-bg: rgba(245, 158, 11, 0.1);
    --info: #3b82f6;
    --info-bg: rgba(59, 130, 246, 0.1);
    --font-primary: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-arabic: 'Cairo', 'Inter', sans-serif;
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    --radius-md: 10px;
    --radius-lg: 16px;
    --radius-xl: 24px;
    --radius-full: 9999px;
}

/* Dark Mode Variables */
[data-theme="dark"] {
    --primary-900: #0f172a;
    --primary-800: #1e293b;
    --primary-700: #334155;
    --primary-600: #475569;
    --primary-500: #64748b;
    --bg-primary: #0f172a;
    --bg-card: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --text-muted: #64748b;
    --border-color: #334155;
    --border-light: #1e293b;
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.5);
}

[dir="rtl"] { --font-primary: var(--font-arabic); }
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; scroll-behavior: smooth; }
body {
    font-family: var(--font-primary);
    background: linear-gradient(180deg, var(--bg-primary) 0%, var(--border-color) 100%);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    transition: all 0.3s ease;
}

.main-header {
    background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-800) 50%, var(--primary-700) 100%);
    color: var(--text-light);
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: var(--shadow-xl);
}

.header-content {
    max-width: 1600px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
    flex-wrap: wrap;
}

.logo-section { display: flex; align-items: center; gap: 1rem; }
.logo-icon {
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.75rem;
    box-shadow: var(--shadow-lg);
}
.logo-text h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    color: #fff;
}
.logo-text span { font-size: 0.875rem; color: var(--primary-300); }

.header-controls { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
.control-group { display: flex; align-items: center; gap: 0.5rem; }
.control-group label { font-size: 0.875rem; color: var(--primary-300); font-weight: 500; }
.control-group select, .control-group button {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #ffffff;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
}
.control-group select:hover, .control-group button:hover {
    background: rgba(255, 255, 255, 0.2);
}
.control-group select option { background: var(--primary-800); color: #ffffff; }

/* Dark Mode Toggle */
.theme-toggle {
    width: 50px;
    height: 26px;
    background: rgba(255,255,255,0.2);
    border-radius: var(--radius-full);
    position: relative;
    cursor: pointer;
    transition: all 0.3s;
}
.theme-toggle::after {
    content: '‚òÄÔ∏è';
    position: absolute;
    width: 22px;
    height: 22px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.3s;
}
[data-theme="dark"] .theme-toggle::after {
    left: 26px;
    content: 'üåô';
}

/* PDF Export Button */
.btn-export {
    background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
    color: var(--primary-900);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    border: none;
}
.btn-export:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.main-container { max-width: 1600px; margin: 0 auto; padding: 2rem; }

/* Upload Section */
.upload-section { margin-bottom: 2rem; }
.upload-box {
    background: var(--bg-card);
    border: 2px dashed var(--border-color);
    border-radius: var(--radius-xl);
    padding: 3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}
.upload-box:hover { border-color: var(--primary-500); transform: translateY(-2px); box-shadow: var(--shadow-xl); }
.upload-box.drag-over { border-color: var(--accent-gold); background: rgba(214, 158, 46, 0.05); }
.upload-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto 1.5rem;
    background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
    border-radius: var(--radius-xl);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
}
.upload-box h2 { font-size: 1.5rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; }
.upload-box p { color: var(--text-secondary); margin-bottom: 1.5rem; }
.file-input-wrapper { position: relative; display: inline-block; }
.file-input-wrapper input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
.btn-upload {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
    color: #ffffff;
    padding: 0.875rem 2rem;
    border-radius: var(--radius-full);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
}
.upload-hint { display: block; font-size: 0.875rem; color: var(--text-muted); margin-top: 1rem; }
.processing-indicator { display: none; align-items: center; justify-content: center; gap: 0.75rem; padding: 1rem; color: var(--primary-600); }
.processing-indicator.active { display: flex; }
.spinner { width: 24px; height: 24px; border: 3px solid var(--border-color); border-top-color: var(--primary-500); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Company Info */
.company-info {
    display: none;
    background: linear-gradient(135deg, var(--primary-800) 0%, var(--primary-700) 100%);
    border-radius: var(--radius-xl);
    padding: 1.5rem 2rem;
    margin-bottom: 2rem;
    color: #ffffff;
}
.company-info.visible { display: block; }
.company-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
.company-logo {
    width: 48px; height: 48px;
    background: var(--accent-gold);
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; font-weight: 700;
}
.company-name { font-size: 1.75rem; font-weight: 700; margin: 0; }
.company-meta { display: flex; flex-wrap: wrap; gap: 2rem; }
.meta-item { display: flex; flex-direction: column; gap: 0.25rem; }
.meta-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--primary-300); }
.meta-value { font-size: 1rem; font-weight: 600; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
/* INVESTMENT SCORE PANEL - NEW */
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.investment-score-panel {
    display: none;
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg);
}
.investment-score-panel.visible { display: block; }

.score-header {
    text-align: center;
    margin-bottom: 2rem;
}
.score-header h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.score-main-grid {
    display: grid;
    grid-template-columns: 300px 1fr 300px;
    gap: 2rem;
    align-items: start;
}

@media (max-width: 1200px) {
    .score-main-grid {
        grid-template-columns: 1fr;
    }
}

/* Investment Score Gauge */
.score-gauge-container {
    display: flex;
    flex-direction: column;
    align-items: center;
}
.score-gauge {
    position: relative;
    width: 220px;
    height: 220px;
}
.score-gauge svg {
    transform: rotate(-90deg);
}
.score-gauge-bg {
    fill: none;
    stroke: var(--border-color);
    stroke-width: 20;
}
.score-gauge-fill {
    fill: none;
    stroke-width: 20;
    stroke-linecap: round;
    transition: stroke-dashoffset 1s ease, stroke 0.5s ease;
}
.score-value {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
}
.score-number {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1;
}
.score-label {
    font-size: 0.875rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

/* Recommendation Badge */
.recommendation-badge {
    margin-top: 1.5rem;
    padding: 1rem 2rem;
    border-radius: var(--radius-full);
    font-size: 1.25rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    animation: pulse 2s infinite;
}
.recommendation-badge.buy {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
}
.recommendation-badge.hold {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
}
.recommendation-badge.sell {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

/* Score Breakdown */
.score-breakdown {
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
}
.score-breakdown h3 {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.breakdown-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-light);
}
.breakdown-item:last-child { border-bottom: none; }
.breakdown-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}
.breakdown-icon {
    width: 32px;
    height: 32px;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
}
.breakdown-icon.liquidity { background: rgba(59, 130, 246, 0.1); }
.breakdown-icon.profitability { background: rgba(16, 185, 129, 0.1); }
.breakdown-icon.leverage { background: rgba(245, 158, 11, 0.1); }
.breakdown-icon.valuation { background: rgba(139, 92, 246, 0.1); }
.breakdown-icon.growth { background: rgba(236, 72, 153, 0.1); }
.breakdown-name { font-weight: 500; color: var(--text-secondary); }
.breakdown-score {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.breakdown-value {
    font-weight: 700;
    font-size: 1.125rem;
}
.breakdown-bar {
    width: 60px;
    height: 6px;
    background: var(--border-color);
    border-radius: var(--radius-full);
    overflow: hidden;
}
.breakdown-bar-fill {
    height: 100%;
    border-radius: var(--radius-full);
    transition: width 0.5s ease;
}

/* AI Insights Panel */
.ai-insights-panel {
    background: linear-gradient(135deg, var(--primary-800) 0%, var(--primary-900) 100%);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    color: white;
}
.ai-insights-panel h3 {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.ai-badge {
    background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 100%);
    color: var(--primary-900);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-md);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
}
.insight-item {
    background: rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-left: 3px solid;
}
.insight-item:last-child { margin-bottom: 0; }
.insight-item.positive { border-left-color: var(--positive); }
.insight-item.negative { border-left-color: var(--negative); }
.insight-item.warning { border-left-color: var(--warning); }
.insight-item.info { border-left-color: var(--info); }
.insight-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.insight-text {
    font-size: 0.875rem;
    color: var(--primary-300);
    line-height: 1.5;
}

/* Tab Navigation */
.tab-navigation {
    display: none;
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    padding: 0.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
    overflow-x: auto;
}
.tab-navigation.visible { display: flex; }
.tab-btn {
    flex: 1;
    min-width: max-content;
    padding: 1rem 1.5rem;
    background: transparent;
    border: none;
    border-radius: var(--radius-lg);
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.2s;
}
.tab-btn:hover { background: rgba(49, 130, 206, 0.1); color: var(--primary-600); }
.tab-btn.active { background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%); color: #ffffff; }
.tab-icon { font-size: 1.125rem; }
.tab-panel { display: none; animation: fadeIn 0.4s ease; }
.tab-panel.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Cards */
.card { background: var(--bg-card); border-radius: var(--radius-xl); box-shadow: var(--shadow-md); overflow: hidden; margin-bottom: 1.5rem; }
.card-header { background: var(--bg-primary); padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border-color); }
.card-title { font-size: 1.125rem; font-weight: 700; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
.card-body { padding: 1.5rem; }

/* KPI Grid */
.kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
.kpi-card {
    background: var(--bg-card);
    border-radius: var(--radius-xl);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
    transition: all 0.3s;
}
.kpi-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary-500); }
.kpi-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-xl); }
.kpi-card.positive::before { background: var(--positive); }
.kpi-card.negative::before { background: var(--negative); }
.kpi-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
.kpi-label { font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }
.kpi-icon { width: 40px; height: 40px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 1.25rem; background: var(--info-bg); }
.kpi-value { font-size: 2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; }
.kpi-change { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.875rem; font-weight: 600; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); }
.kpi-change.positive { background: var(--positive-bg); color: var(--positive); }
.kpi-change.negative { background: var(--negative-bg); color: var(--negative); }

/* Statement Sections */
.statement-section { margin-bottom: 2rem; }
.section-title {
    font-size: 1.25rem; font-weight: 700; color: var(--text-primary);
    margin-bottom: 1rem; padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--primary-500);
    display: flex; align-items: center; gap: 0.75rem;
}
.section-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%);
    border-radius: var(--radius-md);
    display: flex; align-items: center; justify-content: center;
    color: #ffffff; font-size: 1rem;
}
.statement-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
.statement-item {
    background: var(--bg-primary);
    border-radius: var(--radius-md);
    padding: 1rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border-light);
}
.statement-item:hover { background: var(--bg-card); box-shadow: var(--shadow-md); }
.item-label { color: var(--text-secondary); font-weight: 500; }
.item-value { font-weight: 700; color: var(--text-primary); }

/* Charts */
.chart-container { position: relative; height: 350px; padding: 1rem; }
.chart-wrapper { background: var(--bg-card); border-radius: var(--radius-xl); padding: 1.5rem; box-shadow: var(--shadow-md); margin-bottom: 2rem; }
.chart-title { font-size: 1.125rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }

/* Data Tables */
.data-table { width: 100%; border-collapse: collapse; font-size: 0.9375rem; }
.data-table thead { background: linear-gradient(135deg, var(--primary-800) 0%, var(--primary-700) 100%); color: #ffffff; }
.data-table th { padding: 1rem 1.25rem; text-align: left; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }
.data-table tbody tr { border-bottom: 1px solid var(--border-light); }
.data-table tbody tr:hover { background: var(--bg-primary); }
.data-table td { padding: 1rem 1.25rem; }
.data-table .positive { color: var(--positive); }
.data-table .negative { color: var(--negative); }

/* Ratio Categories */
.ratio-categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
.ratio-category { background: var(--bg-card); border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-md); }
.ratio-category-header { padding: 1rem 1.5rem; font-weight: 700; color: #ffffff; text-transform: uppercase; font-size: 0.875rem; }
.ratio-category.liquidity .ratio-category-header { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
.ratio-category.profitability .ratio-category-header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.ratio-category.leverage .ratio-category-header { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.ratio-list { padding: 1rem; }
.ratio-item { display: flex; justify-content: space-between; align-items: center; padding: 0.875rem 1rem; background: var(--bg-primary); border-radius: var(--radius-md); margin-bottom: 0.5rem; }
.ratio-item:last-child { margin-bottom: 0; }
.ratio-name { font-weight: 500; color: var(--text-secondary); }
.ratio-value { font-weight: 700; font-size: 1.125rem; padding: 0.25rem 0.75rem; border-radius: var(--radius-full); }
.ratio-value.good { background: var(--positive-bg); color: var(--positive); }
.ratio-value.warning { background: var(--warning-bg); color: var(--warning); }
.ratio-value.bad { background: var(--negative-bg); color: var(--negative); }

/* Valuation Grid */
.valuation-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
.valuation-card { background: var(--bg-card); border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-md); }
.valuation-card-header { background: linear-gradient(135deg, var(--primary-600) 0%, var(--primary-700) 100%); color: #ffffff; padding: 1.25rem 1.5rem; }
.valuation-card-header h4 { font-size: 1rem; font-weight: 700; margin: 0; text-transform: uppercase; }
.valuation-card-body { padding: 1.5rem; }
.valuation-main-value { font-size: 2.5rem; font-weight: 700; color: var(--primary-700); margin-bottom: 1rem; }
[data-theme="dark"] .valuation-main-value { color: var(--primary-400); }
.valuation-details { list-style: none; }
.valuation-details li { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-light); }
.valuation-details li:last-child { border-bottom: none; }
.detail-label { color: var(--text-secondary); }
.detail-value { font-weight: 600; color: var(--text-primary); }

/* Decision Section */
.decision-section { background: var(--bg-card); border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-lg); margin-bottom: 2rem; }
.decision-header { background: linear-gradient(135deg, var(--primary-800) 0%, var(--primary-700) 100%); color: #ffffff; padding: 2rem; text-align: center; }
.decision-header h3 { font-size: 1.75rem; font-weight: 700; margin: 0 0 0.5rem 0; }
.decision-header p { color: var(--primary-300); }
.decision-body { padding: 2rem; }
.decision-block { margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border-color); }
.decision-block:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
.decision-block h4 { font-size: 1.125rem; font-weight: 700; color: var(--primary-700); margin-bottom: 1rem; }
[data-theme="dark"] .decision-block h4 { color: var(--primary-400); }
.decision-block p { color: var(--text-secondary); line-height: 1.8; white-space: pre-line; }
.final-verdict { background: linear-gradient(135deg, var(--positive) 0%, #059669 100%); color: #ffffff; padding: 2rem; border-radius: var(--radius-xl); text-align: center; }
.final-verdict.negative-verdict { background: linear-gradient(135deg, var(--negative) 0%, #dc2626 100%); }
.verdict-label { font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.9; margin-bottom: 0.5rem; }
.verdict-text { font-size: 1.5rem; font-weight: 700; }

/* Mapping Report */
.mapping-report { background: var(--bg-card); border-radius: var(--radius-xl); overflow: hidden; box-shadow: var(--shadow-md); margin-top: 2rem; display: none; }
.mapping-report.visible { display: block; }
.mapping-header { background: var(--bg-primary); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
.mapping-title { font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; }
.mapping-toggle { transition: transform 0.3s; }
.mapping-toggle.open { transform: rotate(180deg); }
.mapping-content { display: none; padding: 1.5rem; }
.mapping-content.visible { display: block; }
.mapping-stats { display: flex; gap: 1.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
.stat-box { padding: 1rem 1.5rem; border-radius: var(--radius-md); text-align: center; min-width: 120px; }
.stat-box.found { background: var(--positive-bg); }
.stat-box.missing { background: var(--negative-bg); }
.stat-number { font-size: 2rem; font-weight: 700; }
.stat-box.found .stat-number { color: var(--positive); }
.stat-box.missing .stat-number { color: var(--negative); }
.stat-label { font-size: 0.875rem; color: var(--text-secondary); }
.mapping-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; }
.mapping-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-primary); border-radius: var(--radius-md); font-size: 0.875rem; }
.mapping-item.found { border-left: 3px solid var(--positive); }
.mapping-status { font-size: 1rem; }

/* Grid Layouts */
.grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; }

/* Footer */
.main-footer {
    background: var(--primary-900);
    color: var(--text-light);
    padding: 2rem;
    margin-top: 3rem;
}
.footer-content {
    max-width: 1600px;
    margin: 0 auto;
    text-align: center;
}
.footer-brand { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem; }
.footer-credit { font-size: 0.875rem; color: var(--primary-300); }

/* Print Styles */
@media print {
    .main-header, .upload-section, .tab-navigation, .mapping-report { display: none !important; }
    .tab-panel { display: block !important; page-break-inside: avoid; }
    body { background: white; }
}
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">üìä</div>
                <div class="logo-text">
                    <h1 id="platformTitle">Financial Analysis Platform</h1>
                    <span id="platformSubtitle">Executive Decision Support System</span>
                </div>
            </div>
            <div class="header-controls">
                <div class="control-group">
                    <label id="langLabel">Language:</label>
                    <select id="languageToggle">
                        <option value="en">English</option>
                        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    </select>
                </div>
                <div class="control-group">
                    <label id="currLabel">Currency:</label>
                    <select id="currencyToggle">
                        <option value="USD">$ USD</option>
                        <option value="SAR">Ô∑º SAR</option>
                        <option value="EUR">‚Ç¨ EUR</option>
                        <option value="GBP">¬£ GBP</option>
                    </select>
                </div>
                <div class="control-group">
                    <div class="theme-toggle" id="themeToggle" title="Toggle Dark Mode"></div>
                </div>
                <div class="control-group">
                    <button class="btn-export" id="exportPdfBtn" style="display:none;">
                        <span>üìÑ</span>
                        <span id="exportPdfText">Export PDF</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="main-container" id="mainContent">
        <section id="uploadSection" class="upload-section">
            <div class="upload-box" id="uploadBox">
                <div class="upload-icon">üìÅ</div>
                <h2 id="uploadTitle">Upload Financial Data</h2>
                <p id="uploadDesc">Drop your Excel file here or click to browse</p>
                <div class="file-input-wrapper">
                    <button class="btn-upload">
                        <span>üìÑ</span>
                        <span id="selectFileBtn">Select Excel File</span>
                    </button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls,.pdf">
                </div>
                <span class="upload-hint" id="uploadHint">Supported: PDF financial reports, Excel (.xlsx, .xls)</span>
                <div class="processing-indicator" id="processingIndicator">
                    <div class="spinner"></div>
                    <span id="processingText">Processing financial data...</span>
                </div>
            </div>
        </section>

        <section id="companyInfo" class="company-info">
            <div class="company-header">
                <div class="company-logo" id="companyLogo">A</div>
                <h2 class="company-name" id="companyName">Company Name</h2>
            </div>
            <div class="company-meta">
                <div class="meta-item">
                    <span class="meta-label" id="industryLabel">Industry</span>
                    <span class="meta-value" id="industryValue">-</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label" id="periodLabel">Period</span>
                    <span class="meta-value" id="periodValue">-</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label" id="currencyLabel">Currency</span>
                    <span class="meta-value" id="currencyValue">-</span>
                </div>
                <div class="meta-item">
                    <span class="meta-label" id="objectiveLabel">Objective</span>
                    <span class="meta-value" id="objectiveValue">-</span>
                </div>
            </div>
        </section>

        <!-- NEW: Investment Score Panel -->
        <section id="investmentScorePanel" class="investment-score-panel">
            <div class="score-header">
                <h2 id="investmentScoreTitle">üìà Investment Score & AI Analysis</h2>
            </div>
            <div class="score-main-grid">
                <!-- Score Gauge -->
                <div class="score-gauge-container">
                    <div class="score-gauge">
                        <svg viewBox="0 0 200 200">
                            <circle class="score-gauge-bg" cx="100" cy="100" r="80"></circle>
                            <circle class="score-gauge-fill" id="scoreGaugeFill" cx="100" cy="100" r="80" stroke-dasharray="502" stroke-dashoffset="502"></circle>
                        </svg>
                        <div class="score-value">
                            <div class="score-number" id="investmentScoreValue">0</div>
                            <div class="score-label" id="scoreOfLabel">of 100</div>
                        </div>
                    </div>
                    <div class="recommendation-badge" id="recommendationBadge">
                        <span id="recommendationIcon">üìä</span>
                        <span id="recommendationText">ANALYZING...</span>
                    </div>
                </div>

                <!-- Score Breakdown -->
                <div class="score-breakdown">
                    <h3><span>üìä</span> <span id="scoreBreakdownTitle">Score Breakdown</span></h3>
                    <div id="scoreBreakdownContent"></div>
                </div>

                <!-- AI Insights -->
                <div class="ai-insights-panel">
                    <h3>
                        <span>ü§ñ</span>
                        <span id="aiInsightsTitle">AI Insights</span>
                        <span class="ai-badge">SMART</span>
                    </h3>
                    <div id="aiInsightsContent"></div>
                </div>
            </div>
        </section>

        <nav id="tabNavigation" class="tab-navigation">
            <button class="tab-btn active" data-tab="overview">
                <span class="tab-icon">üìã</span>
                <span class="tab-label" id="tabOverview">Overview</span>
            </button>
            <button class="tab-btn" data-tab="horizontal">
                <span class="tab-icon">üìà</span>
                <span class="tab-label" id="tabHorizontal">Horizontal Analysis</span>
            </button>
            <button class="tab-btn" data-tab="vertical">
                <span class="tab-icon">üìä</span>
                <span class="tab-label" id="tabVertical">Vertical Analysis</span>
            </button>
            <button class="tab-btn" data-tab="ratios">
                <span class="tab-icon">‚öñÔ∏è</span>
                <span class="tab-label" id="tabRatios">Ratio Analysis</span>
            </button>
            <button class="tab-btn" data-tab="valuation">
                <span class="tab-icon">üí∞</span>
                <span class="tab-label" id="tabValuation">Valuation & CAPM</span>
            </button>
            <button class="tab-btn" data-tab="decision">
                <span class="tab-icon">‚úÖ</span>
                <span class="tab-label" id="tabDecision">Investment Decision</span>
            </button>
        </nav>

        <div id="tabContent">
            <div id="overviewPanel" class="tab-panel active">
                <div class="kpi-grid" id="kpiGrid"></div>
                <div class="statement-section">
                    <h3 class="section-title"><span class="section-icon">üìÑ</span><span id="incomeTitle">Income Statement</span></h3>
                    <div class="statement-grid" id="incomeGrid"></div>
                </div>
                <div class="statement-section">
                    <h3 class="section-title"><span class="section-icon">üè¶</span><span id="balanceTitle">Balance Sheet</span></h3>
                    <div class="statement-grid" id="balanceGrid"></div>
                </div>
                <div class="statement-section">
                    <h3 class="section-title"><span class="section-icon">üíµ</span><span id="cashflowTitle">Cash Flow</span></h3>
                    <div class="statement-grid" id="cashflowGrid"></div>
                </div>
                <div class="statement-section">
                    <h3 class="section-title"><span class="section-icon">‚öôÔ∏è</span><span id="assumptionsTitle">Key Assumptions</span></h3>
                    <div class="statement-grid" id="assumptionsGrid"></div>
                </div>
            </div>

            <div id="horizontalPanel" class="tab-panel">
                <div class="chart-wrapper">
                    <h3 class="chart-title"><span>üìà</span><span id="horizontalChartTitle">Year-over-Year Comparison</span></h3>
                    <div class="chart-container"><canvas id="horizontalChart"></canvas></div>
                </div>
                <div class="card">
                    <div class="card-header"><span class="card-title"><span>üìä</span><span id="horizontalTableTitle">Horizontal Analysis Data</span></span></div>
                    <div class="card-body">
                        <table class="data-table" id="horizontalTable">
                            <thead><tr id="horizontalTableHead"></tr></thead>
                            <tbody id="horizontalTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="verticalPanel" class="tab-panel">
                <div class="grid-2">
                    <div class="chart-wrapper">
                        <h3 class="chart-title"><span>üìä</span><span id="verticalChartTitle">Cost Structure (% of Revenue)</span></h3>
                        <div class="chart-container"><canvas id="verticalChart"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><span class="card-title"><span>üìã</span><span id="verticalTableTitle">Vertical Analysis Breakdown</span></span></div>
                        <div class="card-body">
                            <table class="data-table" id="verticalTable">
                                <thead><tr><th id="vItemHeader">Item</th><th id="vPercentHeader">% of Revenue</th><th id="vInterpretHeader">Interpretation</th></tr></thead>
                                <tbody id="verticalTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ratiosPanel" class="tab-panel">
                <div class="ratio-categories" id="ratioCategories"></div>
                <div class="chart-wrapper" style="margin-top: 2rem;">
                    <h3 class="chart-title"><span>üìä</span><span id="ratioChartTitle">Financial Ratios Overview</span></h3>
                    <div class="chart-container"><canvas id="ratioChart"></canvas></div>
                </div>
            </div>

            <div id="valuationPanel" class="tab-panel">
                <div class="valuation-grid" id="valuationGrid"></div>
                <div class="card">
                    <div class="card-header"><span class="card-title"><span>üìù</span><span id="capmNotesTitle">CAPM & WACC Notes</span></span></div>
                    <div class="card-body" id="capmNotes"></div>
                </div>
            </div>

            <div id="decisionPanel" class="tab-panel">
                <div class="decision-section">
                    <div class="decision-header">
                        <h3 id="decisionTitle">Investment Decision Report</h3>
                        <p id="decisionSubtitle">Comprehensive Analysis Summary</p>
                    </div>
                    <div class="decision-body" id="decisionBody"></div>
                </div>
            </div>
        </div>

        <div class="mapping-report" id="mappingReport">
            <div class="mapping-header" id="mappingHeader">
                <span class="mapping-title"><span>üìã</span><span id="mappingTitle">Data Mapping Report</span></span>
                <span class="mapping-toggle" id="mappingToggle">‚ñº</span>
            </div>
            <div class="mapping-content" id="mappingContent">
                <div class="mapping-stats" id="mappingStats"></div>
                <div class="mapping-grid" id="mappingGrid"></div>
            </div>
        </div>
    </main>

    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-brand" id="footerBrand">Financial Analysis Platform</div>
            <div class="footer-credit" id="footerCredit">Developed for Advanced Financial Decision Support | Dr. Jou - JoUTricks</div>
        </div>
    </footer>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRANSLATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const translations = {
    en: {
        platformTitle: 'Financial Analysis Platform',
        platformSubtitle: 'Executive Decision Support System',
        langLabel: 'Language:',
        currLabel: 'Currency:',
        uploadTitle: 'Upload Financial Data',
        uploadDesc: 'Drop your Excel file here or click to browse',
        selectFileBtn: 'Select Excel File',
        uploadHint: 'Supported: PDF financial reports, Excel (.xlsx, .xls)',
        processingText: 'Processing financial data...',
        industryLabel: 'Industry',
        periodLabel: 'Period',
        currencyLabel: 'Currency',
        objectiveLabel: 'Objective',
        tabOverview: 'Overview',
        tabHorizontal: 'Horizontal Analysis',
        tabVertical: 'Vertical Analysis',
        tabRatios: 'Ratio Analysis',
        tabValuation: 'Valuation & CAPM',
        tabDecision: 'Investment Decision',
        incomeTitle: 'Income Statement',
        balanceTitle: 'Balance Sheet',
        cashflowTitle: 'Cash Flow',
        assumptionsTitle: 'Key Assumptions',
        horizontalChartTitle: 'Year-over-Year Comparison',
        horizontalTableTitle: 'Horizontal Analysis Data',
        verticalChartTitle: 'Cost Structure (% of Revenue)',
        verticalTableTitle: 'Vertical Analysis Breakdown',
        vItemHeader: 'Item',
        vPercentHeader: '% of Revenue',
        vInterpretHeader: 'Interpretation',
        ratioChartTitle: 'Financial Ratios Overview',
        capmNotesTitle: 'CAPM & WACC Notes',
        decisionTitle: 'Investment Decision Report',
        decisionSubtitle: 'Comprehensive Analysis Summary',
        mappingTitle: 'Data Mapping Report',
        footerBrand: 'Financial Analysis Platform',
        footerCredit: 'Developed for Advanced Financial Decision Support | Dr. Jou - JoUTricks',
        revenue: 'Revenue', cogs: 'COGS', operatingExpenses: 'Operating Expenses',
        ebit: 'EBIT', netIncome: 'Net Income', currentAssets: 'Current Assets',
        totalAssets: 'Total Assets', currentLiabilities: 'Current Liabilities',
        totalLiabilities: 'Total Liabilities', equity: 'Equity', cash: 'Cash',
        totalDebt: 'Total Debt', operatingCashFlow: 'Operating Cash Flow',
        capex: 'CAPEX', freeCashFlow: 'Free Cash Flow', taxRate: 'Tax Rate',
        costOfDebt: 'Cost of Debt', costOfEquity: 'Cost of Equity', wacc: 'WACC',
        riskFreeRate: 'Risk-Free Rate', marketRiskPremium: 'Market Risk Premium',
        beta: 'Beta', npv: 'NPV', irr: 'IRR',
        currentRatio: 'Current Ratio', quickRatio: 'Quick Ratio',
        netMargin: 'Net Margin', roa: 'ROA', roe: 'ROE', debtToEquity: 'Debt/Equity',
        liquidity: 'Liquidity Ratios', profitability: 'Profitability Ratios',
        leverage: 'Leverage Ratios', found: 'Found', missing: 'Missing',
        good: 'Good', warning: 'Warning', bad: 'Poor',
        executiveSummary: 'Executive Summary', keyFindings: 'Key Financial Findings',
        investmentEvaluation: 'Investment Evaluation', finalDecision: 'Final Investment Decision',
        exportPdfText: 'Export PDF',
        investmentScoreTitle: 'üìà Investment Score & AI Analysis',
        scoreOfLabel: 'of 100',
        scoreBreakdownTitle: 'Score Breakdown',
        aiInsightsTitle: 'AI Insights',
        buy: 'BUY',
        hold: 'HOLD',
        sell: 'SELL',
        liquidityScore: 'Liquidity',
        profitabilityScore: 'Profitability',
        leverageScore: 'Leverage',
        valuationScore: 'Valuation',
        growthScore: 'Growth'
    },
    ar: {
        platformTitle: 'ŸÖŸÜÿµÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿßŸÑŸä',
        platformSubtitle: 'ŸÜÿ∏ÿßŸÖ ÿØÿπŸÖ ÿßŸÑŸÇÿ±ÿßÿ± ÿßŸÑÿ™ŸÜŸÅŸäÿ∞Ÿä',
        langLabel: 'ÿßŸÑŸÑÿ∫ÿ©:',
        currLabel: 'ÿßŸÑÿπŸÖŸÑÿ©:',
        uploadTitle: 'ÿ±ŸÅÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©',
        uploadDesc: 'ÿßÿ≥ÿ≠ÿ® ŸÖŸÑŸÅ Excel ŸáŸÜÿß ÿ£Ÿà ÿßŸÜŸÇÿ± ŸÑŸÑÿ™ÿµŸÅÿ≠',
        selectFileBtn: 'ÿßÿÆÿ™ÿ± ŸÖŸÑŸÅ Excel',
        uploadHint: 'ŸÖÿØÿπŸàŸÖ: ÿ™ŸÇÿßÿ±Ÿäÿ± PDF ÿßŸÑŸÖÿßŸÑŸäÿ©ÿå Excel (.xlsx, .xls)',
        processingText: 'ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ©...',
        industryLabel: 'ÿßŸÑŸÇÿ∑ÿßÿπ',
        periodLabel: 'ÿßŸÑŸÅÿ™ÿ±ÿ©',
        currencyLabel: 'ÿßŸÑÿπŸÖŸÑÿ©',
        objectiveLabel: 'ÿßŸÑŸáÿØŸÅ',
        tabOverview: 'ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ©',
        tabHorizontal: 'ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ŸÅŸÇŸä',
        tabVertical: 'ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ÿ£ÿ≥Ÿä',
        tabRatios: 'ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÜÿ≥ÿ®',
        tabValuation: 'ÿßŸÑÿ™ŸÇŸäŸäŸÖ Ÿà CAPM',
        tabDecision: 'ŸÇÿ±ÿßÿ± ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±',
        incomeTitle: 'ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿØÿÆŸÑ',
        balanceTitle: 'ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ© ÿßŸÑÿπŸÖŸàŸÖŸäÿ©',
        cashflowTitle: 'ÿßŸÑÿ™ÿØŸÅŸÇÿßÿ™ ÿßŸÑŸÜŸÇÿØŸäÿ©',
        assumptionsTitle: 'ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂ÿßÿ™ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©',
        horizontalChartTitle: 'ÿßŸÑŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑÿ≥ŸÜŸàŸäÿ©',
        horizontalTableTitle: 'ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ£ŸÅŸÇŸä',
        verticalChartTitle: 'ŸáŸäŸÉŸÑ ÿßŸÑÿ™ŸÉÿßŸÑŸäŸÅ (% ŸÖŸÜ ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™)',
        verticalTableTitle: 'ÿ™ŸÅÿµŸäŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ±ÿ£ÿ≥Ÿä',
        vItemHeader: 'ÿßŸÑÿ®ŸÜÿØ',
        vPercentHeader: '% ŸÖŸÜ ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™',
        vInterpretHeader: 'ÿßŸÑÿ™ŸÅÿ≥Ÿäÿ±',
        ratioChartTitle: 'ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ© ÿπŸÑŸâ ÿßŸÑŸÜÿ≥ÿ® ÿßŸÑŸÖÿßŸÑŸäÿ©',
        capmNotesTitle: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ CAPM Ÿà WACC',
        decisionTitle: 'ÿ™ŸÇÿ±Ÿäÿ± ŸÇÿ±ÿßÿ± ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±',
        decisionSubtitle: 'ŸÖŸÑÿÆÿµ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¥ÿßŸÖŸÑ',
        mappingTitle: 'ÿ™ŸÇÿ±Ÿäÿ± ÿ±ÿ®ÿ∑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™',
        footerBrand: 'ŸÖŸÜÿµÿ© ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿßŸÑŸä',
        footerCredit: 'ŸÖÿ∑Ÿàÿ± ŸÑÿØÿπŸÖ ÿßŸÑŸÇÿ±ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿßŸÑŸäÿ© ÿßŸÑŸÖÿ™ŸÇÿØŸÖÿ© | ÿØ. ÿ¨Ÿà - JoUTricks',
        revenue: 'ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™', cogs: 'ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑŸÖÿ®Ÿäÿπÿßÿ™', operatingExpenses: 'ÿßŸÑŸÖÿµÿ±ŸàŸÅÿßÿ™ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑŸäÿ©',
        ebit: 'ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑŸä', netIncome: 'ÿµÿßŸÅŸä ÿßŸÑÿØÿÆŸÑ', currentAssets: 'ÿßŸÑÿ£ÿµŸàŸÑ ÿßŸÑŸÖÿ™ÿØÿßŸàŸÑÿ©',
        totalAssets: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿ£ÿµŸàŸÑ', currentLiabilities: 'ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖÿßÿ™ ÿßŸÑŸÖÿ™ÿØÿßŸàŸÑÿ©',
        totalLiabilities: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖÿßÿ™', equity: 'ÿ≠ŸÇŸàŸÇ ÿßŸÑŸÖŸÑŸÉŸäÿ©', cash: 'ÿßŸÑŸÜŸÇÿØŸäÿ©',
        totalDebt: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑÿØŸäŸàŸÜ', operatingCashFlow: 'ÿßŸÑÿ™ÿØŸÅŸÇ ÿßŸÑŸÜŸÇÿØŸä ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑŸä',
        capex: 'ÿßŸÑŸÜŸÅŸÇÿßÿ™ ÿßŸÑÿ±ÿ£ÿ≥ŸÖÿßŸÑŸäÿ©', freeCashFlow: 'ÿßŸÑÿ™ÿØŸÅŸÇ ÿßŸÑŸÜŸÇÿØŸä ÿßŸÑÿ≠ÿ±', taxRate: 'ŸÖÿπÿØŸÑ ÿßŸÑÿ∂ÿ±Ÿäÿ®ÿ©',
        costOfDebt: 'ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿØŸäŸÜ', costOfEquity: 'ÿ™ŸÉŸÑŸÅÿ© ÿ≠ŸÇŸàŸÇ ÿßŸÑŸÖŸÑŸÉŸäÿ©', wacc: 'ÿßŸÑŸÖÿ™Ÿàÿ≥ÿ∑ ÿßŸÑŸÖÿ±ÿ¨ÿ≠ ŸÑÿ™ŸÉŸÑŸÅÿ© ÿ±ÿ£ÿ≥ ÿßŸÑŸÖÿßŸÑ',
        riskFreeRate: 'ŸÖÿπÿØŸÑ ÿßŸÑÿÆÿßŸÑŸä ŸÖŸÜ ÿßŸÑŸÖÿÆÿßÿ∑ÿ±', marketRiskPremium: 'ÿπŸÑÿßŸàÿ© ŸÖÿÆÿßÿ∑ÿ± ÿßŸÑÿ≥ŸàŸÇ',
        beta: 'ÿ®Ÿäÿ™ÿß', npv: 'ÿµÿßŸÅŸä ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ©', irr: 'ŸÖÿπÿØŸÑ ÿßŸÑÿπÿßÿ¶ÿØ ÿßŸÑÿØÿßÿÆŸÑŸä',
        currentRatio: 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿØÿßŸàŸÑ', quickRatio: 'ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ≥ŸäŸàŸÑÿ© ÿßŸÑÿ≥ÿ±Ÿäÿπÿ©',
        netMargin: 'ŸáÿßŸÖÿ¥ ÿßŸÑÿ±ÿ®ÿ≠ ÿßŸÑÿµÿßŸÅŸä', roa: 'ÿßŸÑÿπÿßÿ¶ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ÿµŸàŸÑ', roe: 'ÿßŸÑÿπÿßÿ¶ÿØ ÿπŸÑŸâ ÿ≠ŸÇŸàŸÇ ÿßŸÑŸÖŸÑŸÉŸäÿ©',
        debtToEquity: 'ÿßŸÑÿØŸäŸÜ ÿ•ŸÑŸâ ÿ≠ŸÇŸàŸÇ ÿßŸÑŸÖŸÑŸÉŸäÿ©',
        liquidity: 'ŸÜÿ≥ÿ® ÿßŸÑÿ≥ŸäŸàŸÑÿ©', profitability: 'ŸÜÿ≥ÿ® ÿßŸÑÿ±ÿ®ÿ≠Ÿäÿ©', leverage: 'ŸÜÿ≥ÿ® ÿßŸÑÿ±ŸÅÿπ ÿßŸÑŸÖÿßŸÑŸä',
        found: 'ŸÖŸàÿ¨ŸàÿØ', missing: 'ŸÖŸÅŸÇŸàÿØ', good: 'ÿ¨ŸäÿØ', warning: 'ÿ™ÿ≠ÿ∞Ÿäÿ±', bad: 'ÿ∂ÿπŸäŸÅ',
        executiveSummary: 'ÿßŸÑŸÖŸÑÿÆÿµ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞Ÿä', keyFindings: 'ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÖÿßŸÑŸäÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©',
        investmentEvaluation: 'ÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ±', finalDecision: 'ŸÇÿ±ÿßÿ± ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ± ÿßŸÑŸÜŸáÿßÿ¶Ÿä',
        exportPdfText: 'ÿ™ÿµÿØŸäÿ± PDF',
        investmentScoreTitle: 'üìà ÿØÿ±ÿ¨ÿ© ÿßŸÑÿßÿ≥ÿ™ÿ´ŸÖÿßÿ± ŸàÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ∞ŸÉŸä',
        scoreOfLabel: 'ŸÖŸÜ 100',
        scoreBreakdownTitle: 'ÿ™ŸÅÿµŸäŸÑ ÿßŸÑÿØÿ±ÿ¨ÿ©',
        aiInsightsTitle: 'ÿ±ÿ§Ÿâ ÿ∞ŸÉŸäÿ©',
        buy: 'ÿ¥ÿ±ÿßÿ°',
        hold: 'ÿßÿ≠ÿ™ŸÅÿßÿ∏',
        sell: 'ÿ®Ÿäÿπ',
        liquidityScore: 'ÿßŸÑÿ≥ŸäŸàŸÑÿ©',
        profitabilityScore: 'ÿßŸÑÿ±ÿ®ÿ≠Ÿäÿ©',
        leverageScore: 'ÿßŸÑÿ±ŸÅÿπ ÿßŸÑŸÖÿßŸÑŸä',
        valuationScore: 'ÿßŸÑÿ™ŸÇŸäŸäŸÖ',
        growthScore: 'ÿßŸÑŸÜŸÖŸà'
    }
};

const currencySymbols = { USD: '$', SAR: 'Ô∑º', EUR: '‚Ç¨', GBP: '¬£' };
const exchangeRates = { USD: 1, SAR: 3.75, EUR: 0.92, GBP: 0.79 };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentLanguage = 'en';
let currentCurrency = 'USD';
let currentTheme = 'light';
let currentData = null;
let charts = {};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INITIALIZATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    // File upload handlers
    const uploadBox = document.getElementById('uploadBox');
    const fileInput = document.getElementById('fileInput');
    
    uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); uploadBox.classList.add('drag-over'); });
    uploadBox.addEventListener('dragleave', () => { uploadBox.classList.remove('drag-over'); });
    uploadBox.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadBox.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]);
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) processFile(e.target.files[0]);
    });
    
    // Language toggle
    document.getElementById('languageToggle').addEventListener('change', (e) => {
        currentLanguage = e.target.value;
        document.documentElement.lang = currentLanguage;
        document.documentElement.dir = currentLanguage === 'ar' ? 'rtl' : 'ltr';
        applyTranslations();
        if (currentData) renderDashboard();
    });
    
    // Currency toggle
    document.getElementById('currencyToggle').addEventListener('change', (e) => {
        currentCurrency = e.target.value;
        if (currentData) renderDashboard();
    });
    
    // Theme toggle
    document.getElementById('themeToggle').addEventListener('click', () => {
        currentTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', currentTheme);
        if (currentData) updateChartsTheme();
    });
    
    // Tab navigation
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
    });
    
    // Mapping report toggle
    document.getElementById('mappingHeader').addEventListener('click', toggleMappingReport);
    
    // PDF Export
    document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
    
    applyTranslations();
}

function applyTranslations() {
    const t = translations[currentLanguage];
    Object.keys(t).forEach(key => {
        const el = document.getElementById(key);
        if (el) el.textContent = t[key];
    });
}

function switchTab(tabName) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}Panel`).classList.add('active');
}

function toggleMappingReport() {
    const content = document.getElementById('mappingContent');
    const toggle = document.getElementById('mappingToggle');
    content.classList.toggle('visible');
    toggle.classList.toggle('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF EXPORT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportToPDF() {
    const element = document.getElementById('mainContent');
    const companyName = currentData?.company?.name || 'Financial_Report';
    const filename = `${companyName}_Analysis_${new Date().toISOString().split('T')[0]}.pdf`;
    
    const opt = {
        margin: 10,
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };
    
    // Hide upload section temporarily
    const uploadSection = document.getElementById('uploadSection');
    const originalDisplay = uploadSection.style.display;
    uploadSection.style.display = 'none';
    
    html2pdf().set(opt).from(element).save().then(() => {
        uploadSection.style.display = originalDisplay;
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FILE PROCESSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function processFile(file) {
    const fileName = file.name.toLowerCase();
    const isPDF = fileName.endsWith('.pdf');
    const isExcel = fileName.match(/\.xlsx?$/i);
    
    if (!isPDF && !isExcel) {
        alert(currentLanguage === 'ar' ? 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ PDF ÿ£Ÿà Excel' : 'Please upload a PDF or Excel file');
        return;
    }
    
    document.getElementById('processingIndicator').classList.add('active');
    
    try {
        let data;
        
        // Handle PDF files
        if (isPDF) {
            data = await processPDFFile(file);
        }
        // Handle Excel files
        else {
            const excelData = await readExcelFile(file);
            data = parseFinancialData(excelData);
        }
        
        currentData = data;
        renderDashboard();
        
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('companyInfo').classList.add('visible');
        document.getElementById('investmentScorePanel').classList.add('visible');
        document.getElementById('tabNavigation').classList.add('visible');
        document.getElementById('mappingReport').classList.add('visible');
        document.getElementById('exportPdfBtn').style.display = 'flex';
    } catch (error) {
        console.error('Error:', error);
        alert(currentLanguage === 'ar' ? 'ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ' : 'Error processing file');
    }
    
    document.getElementById('processingIndicator').classList.remove('active');
}

function readExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(e.target.result, { type: 'array' });
                const sheets = {};
                workbook.SheetNames.forEach(name => {
                    sheets[name] = XLSX.utils.sheet_to_json(workbook.Sheets[name], { header: 1 });
                });
                resolve(sheets);
            } catch (err) { reject(err); }
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PDF PROCESSING VIA N8N
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function processPDFFile(file) {
    const statusEl = document.getElementById('processingText');
    const originalText = statusEl.textContent;
    
    statusEl.textContent = currentLanguage === 'ar' 
        ? 'ÿ¨ÿßÿ±Ÿä ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ PDF... ŸÇÿØ Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ 30-60 ÿ´ÿßŸÜŸäÿ©'
        : 'Extracting data from PDF... This may take 30-60 seconds';
    
    try {
        const formData = new FormData();
        formData.append('data', file);
        
        const response = await fetch('https://tg.joutricks.cfd/webhook/extract-financial-data', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`Server error: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        
        // If Excel file returned
        if (contentType && contentType.includes('application/vnd.openxmlformats')) {
            statusEl.textContent = currentLanguage === 'ar'
                ? 'ÿ™ŸÖ ÿßŸÑÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨! ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...'
                : 'Extracted! Analyzing data...';
            
            const excelBlob = await response.blob();
            const excelFile = new File([excelBlob], 'extracted_data.xlsx');
            const excelData = await readExcelFile(excelFile);
            const parsedData = parseFinancialData(excelData);
            
            statusEl.textContent = originalText;
            return parsedData;
        }
        // If JSON returned
        else {
            const result = await response.json();
            
            if (result.error) {
                throw new Error(result.error);
            }
            
            if (result.company || result.income) {
                statusEl.textContent = originalText;
                return result;
            }
            
            throw new Error('Unexpected response format');
        }
        
    } catch (error) {
        console.error('PDF processing error:', error);
        
        let errorMsg = currentLanguage === 'ar'
            ? 'ŸÅÿ¥ŸÑ ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ PDF. '
            : 'Failed to extract data from PDF. ';
        
        if (error.message.includes('Failed to fetch')) {
            errorMsg += currentLanguage === 'ar'
                ? 'ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑŸÉ ÿ®ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™.'
                : 'Please check your internet connection.';
        } else if (error.message.includes('500')) {
            errorMsg += currentLanguage === 'ar'
                ? 'ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿÆÿßÿØŸÖ. ÿ≠ÿßŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.'
                : 'Server error. Please try again.';
        } else {
            errorMsg += error.message;
        }
        
        alert(errorMsg);
        statusEl.textContent = originalText;
        throw error;
    }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATA PARSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseFinancialData(sheets) {
    const data = {
        company: { name: '', industry: '', period: '', currency: '', objective: '' },
        income: {}, balance: {}, cashflow: {}, assumptions: {},
        horizontal: [], vertical: [], ratios: {}, valuation: {},
        decision: { summary: '', findings: '', evaluation: '', final: '' },
        mapping: { found: [], missing: [] }
    };
    
    const mainSheet = Object.values(sheets)[0] || [];
    
    // Parse all rows
    mainSheet.forEach((row, idx) => {
        if (!row || row.length === 0) return;
        
        const cellA = String(row[0] || '').toLowerCase().trim();
        const cellB = row[1];
        const cellC = String(row[2] || '').toLowerCase().trim();
        const cellD = row[3];
        
        // Company info
        if (cellA.includes('company name')) { data.company.name = cellB || ''; data.mapping.found.push('Company Name'); }
        if (cellC.includes('industry')) data.company.industry = cellD || '';
        if (cellA.includes('period') || cellC.includes('period')) data.company.period = row[5] || cellD || '';
        if (cellC.includes('currency') || cellA.includes('currency')) data.company.currency = row[7] || cellD || '';
        if (cellA.includes('objective')) data.company.objective = cellB || '';
        
        // Income Statement
        if (cellA === 'revenue' || cellA.includes('ÿ•Ÿäÿ±ÿßÿØÿßÿ™')) { data.income.revenue = parseNum(cellB); data.mapping.found.push('Revenue'); }
        if (cellA === 'cogs' || cellA.includes('cost of')) { data.income.cogs = parseNum(cellB); data.mapping.found.push('COGS'); }
        if (cellA.includes('operating exp')) { data.income.operatingExpenses = parseNum(cellB); data.mapping.found.push('Operating Expenses'); }
        if (cellA === 'ebit' || cellA.includes('operating income')) { data.income.ebit = parseNum(cellB); data.mapping.found.push('EBIT'); }
        if (cellA.includes('net income') || cellA === 'net income') { data.income.netIncome = parseNum(cellB); data.mapping.found.push('Net Income'); }
        
        // Balance Sheet
        if (cellC.includes('current assets')) { data.balance.currentAssets = parseNum(cellD); data.mapping.found.push('Current Assets'); }
        if (cellC.includes('total assets')) { data.balance.totalAssets = parseNum(cellD); data.mapping.found.push('Total Assets'); }
        if (cellC.includes('current liab')) { data.balance.currentLiabilities = parseNum(cellD); data.mapping.found.push('Current Liabilities'); }
        if (cellC.includes('total liab')) { data.balance.totalLiabilities = parseNum(cellD); data.mapping.found.push('Total Liabilities'); }
        if (cellC === 'equity' || cellC.includes('equity')) { data.balance.equity = parseNum(cellD); data.mapping.found.push('Equity'); }
        if (cellC === 'cash') { data.balance.cash = parseNum(cellD); data.mapping.found.push('Cash'); }
        if (cellC.includes('total debt')) { data.balance.totalDebt = parseNum(cellD); data.mapping.found.push('Total Debt'); }
        
        // Cash Flow
        if (cellA.includes('operating cash')) { data.cashflow.operatingCashFlow = parseNum(cellB); data.mapping.found.push('Operating Cash Flow'); }
        if (cellA === 'capex' || cellA.includes('capital exp')) { data.cashflow.capex = parseNum(cellB); data.mapping.found.push('CAPEX'); }
        if (cellA.includes('free cash')) { data.cashflow.freeCashFlow = parseNum(cellB); data.mapping.found.push('Free Cash Flow'); }
        
        // Assumptions
        if (cellA.includes('tax rate')) { data.assumptions.taxRate = parseNum(cellB); data.mapping.found.push('Tax Rate'); }
        if (cellA.includes('cost of debt')) { data.assumptions.costOfDebt = parseNum(cellB); data.mapping.found.push('Cost of Debt'); }
        if (cellA.includes('cost of equity')) { data.assumptions.costOfEquity = parseNum(cellB); data.mapping.found.push('Cost of Equity'); }
        if (cellA === 'wacc') { data.assumptions.wacc = parseNum(cellB); data.mapping.found.push('WACC'); }
        
        // Vertical Analysis
        if (cellC.includes('cogs') && cellC.includes('sales')) { data.vertical.push({ item: 'COGS', percent: parseNum(cellD) }); }
        if (cellC.includes('opex') && cellC.includes('sales')) { data.vertical.push({ item: 'OpEx', percent: parseNum(cellD) }); }
        if (cellC.includes('ebit') && cellC.includes('sales')) { data.vertical.push({ item: 'EBIT', percent: parseNum(cellD) }); }
        if (cellC.includes('net income') && cellC.includes('sales')) { data.vertical.push({ item: 'Net Income', percent: parseNum(cellD) }); }
        
        // Ratios
        if (cellC.includes('current ratio')) { data.ratios.currentRatio = parseNum(cellD); data.mapping.found.push('Current Ratio'); }
        if (cellC.includes('quick ratio')) { data.ratios.quickRatio = parseNum(cellD); data.mapping.found.push('Quick Ratio'); }
        if (cellC.includes('net margin')) { data.ratios.netMargin = parseNum(cellD); data.mapping.found.push('Net Margin'); }
        if (cellC === 'roa' || cellC.includes('return on assets')) { data.ratios.roa = parseNum(cellD); data.mapping.found.push('ROA'); }
        if (cellC === 'roe' || cellC.includes('return on equity')) { data.ratios.roe = parseNum(cellD); data.mapping.found.push('ROE'); }
        if (cellC.includes('debt') && cellC.includes('equity')) { data.ratios.debtToEquity = parseNum(cellD); data.mapping.found.push('Debt/Equity'); }
        
        // Capital Budgeting
        if (cellA === 'npv' || cellA.includes('net present')) { data.valuation.npv = parseNum(cellB); data.mapping.found.push('NPV'); }
        if (cellA === 'irr') { data.valuation.irr = cellB; data.mapping.found.push('IRR'); }
        
        // Horizontal Analysis
        if ((cellA === 'revenue' || cellA === 'net income' || cellA === 'total assets' || cellA === 'equity') && row[1] && row[2]) {
            data.horizontal.push({ item: cellA, y2024: parseNum(row[1]), y2023: parseNum(row[2]), change: parseNum(row[3]) });
        }
        
        // CAPM Notes
        if (cellA.includes('capm') || cellA.includes('risk-free') || cellA.includes('market risk') || cellA.includes('beta')) {
            data.valuation.capmNotes = (data.valuation.capmNotes || '') + '\n' + row[0];
        }
    });
    
    // Decision sheet
    const decisionSheet = Object.values(sheets)[1] || [];
    decisionSheet.forEach(row => {
        if (!row || !row[0]) return;
        const text = String(row[0]);
        if (text.includes('Executive Summary')) data.decision.summary = text.replace('Executive Summary', '').trim();
        if (text.includes('Key Financial')) data.decision.findings = text.replace('Key Financial Findings', '').trim();
        if (text.includes('Investment Evaluation')) data.decision.evaluation = text.replace('Investment Evaluation', '').trim();
        if (text.includes('Final Investment Decision')) data.decision.final = text.replace('Final Investment Decision', '').trim();
    });
    
    // Calculate derived values
    if (!data.cashflow.freeCashFlow && data.cashflow.operatingCashFlow && data.cashflow.capex) {
        data.cashflow.freeCashFlow = data.cashflow.operatingCashFlow - data.cashflow.capex;
    }
    
    // Unique found items
    data.mapping.found = [...new Set(data.mapping.found)];
    
    return data;
}

function parseNum(val) {
    if (val === null || val === undefined || val === '' || val === '#NUM!' || val === '#N/A') return null;
    const num = typeof val === 'number' ? val : parseFloat(String(val).replace(/[^0-9.-]/g, ''));
    return isNaN(num) ? null : num;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVESTMENT SCORE CALCULATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calculateInvestmentScore(d) {
    const scores = {
        liquidity: 0,
        profitability: 0,
        leverage: 0,
        valuation: 0,
        growth: 0
    };
    
    // Liquidity Score (0-20)
    const currentRatio = d.ratios.currentRatio || 0;
    const quickRatio = d.ratios.quickRatio || 0;
    if (currentRatio >= 2) scores.liquidity = 20;
    else if (currentRatio >= 1.5) scores.liquidity = 16;
    else if (currentRatio >= 1) scores.liquidity = 12;
    else if (currentRatio >= 0.5) scores.liquidity = 6;
    else scores.liquidity = 2;
    
    // Profitability Score (0-25)
    const netMargin = (d.ratios.netMargin || 0);
    const roe = (d.ratios.roe || 0);
    const roa = (d.ratios.roa || 0);
    
    let profitScore = 0;
    if (netMargin > 0.15) profitScore += 10;
    else if (netMargin > 0.08) profitScore += 7;
    else if (netMargin > 0.03) profitScore += 4;
    else if (netMargin > 0) profitScore += 2;
    
    if (roe > 0.20) profitScore += 8;
    else if (roe > 0.12) profitScore += 6;
    else if (roe > 0.05) profitScore += 4;
    else if (roe > 0) profitScore += 2;
    
    if (roa > 0.10) profitScore += 7;
    else if (roa > 0.05) profitScore += 5;
    else if (roa > 0.02) profitScore += 3;
    else if (roa > 0) profitScore += 1;
    
    scores.profitability = Math.min(25, profitScore);
    
    // Leverage Score (0-20) - Lower debt is better
    const debtToEquity = d.ratios.debtToEquity || 0;
    if (debtToEquity < 0.5) scores.leverage = 20;
    else if (debtToEquity < 1) scores.leverage = 16;
    else if (debtToEquity < 1.5) scores.leverage = 12;
    else if (debtToEquity < 2) scores.leverage = 8;
    else scores.leverage = 4;
    
    // Valuation Score (0-20)
    const npv = d.valuation.npv || 0;
    const irr = parseNum(d.valuation.irr) || 0;
    const wacc = d.assumptions.wacc || 0.1;
    
    let valScore = 0;
    if (npv > 0) valScore += 10;
    else if (npv === 0) valScore += 5;
    
    if (irr > wacc * 1.5) valScore += 10;
    else if (irr > wacc) valScore += 7;
    else if (irr > wacc * 0.8) valScore += 4;
    
    scores.valuation = Math.min(20, valScore);
    
    // Growth Score (0-15)
    const fcf = d.cashflow.freeCashFlow || 0;
    const revenue = d.income.revenue || 1;
    const fcfMargin = fcf / revenue;
    
    if (fcfMargin > 0.15) scores.growth = 15;
    else if (fcfMargin > 0.08) scores.growth = 12;
    else if (fcfMargin > 0.03) scores.growth = 8;
    else if (fcfMargin > 0) scores.growth = 5;
    else scores.growth = 2;
    
    const totalScore = scores.liquidity + scores.profitability + scores.leverage + scores.valuation + scores.growth;
    
    return { scores, totalScore };
}

function getRecommendation(score) {
    if (score >= 70) return { type: 'buy', icon: 'üöÄ', color: '#10b981' };
    if (score >= 45) return { type: 'hold', icon: '‚è∏Ô∏è', color: '#f59e0b' };
    return { type: 'sell', icon: '‚ö†Ô∏è', color: '#ef4444' };
}

function generateAIInsights(d, scores, totalScore) {
    const t = translations[currentLanguage];
    const insights = [];
    
    // Liquidity insight
    const currentRatio = d.ratios.currentRatio || 0;
    if (currentRatio >= 2) {
        insights.push({
            type: 'positive',
            title: currentLanguage === 'ar' ? 'ÿ≥ŸäŸàŸÑÿ© ŸÇŸàŸäÿ©' : 'Strong Liquidity',
            text: currentLanguage === 'ar' 
                ? `ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿØÿßŸàŸÑ ${currentRatio.toFixed(2)} ÿ™ÿ¥Ÿäÿ± ÿ•ŸÑŸâ ŸÇÿØÿ±ÿ© ŸÖŸÖÿ™ÿßÿ≤ÿ© ÿπŸÑŸâ ÿ≥ÿØÿßÿØ ÿßŸÑÿßŸÑÿ™ÿ≤ÿßŸÖÿßÿ™ ŸÇÿµŸäÿ±ÿ© ÿßŸÑÿ£ÿ¨ŸÑ.`
                : `Current ratio of ${currentRatio.toFixed(2)} indicates excellent ability to meet short-term obligations.`
        });
    } else if (currentRatio < 1) {
        insights.push({
            type: 'negative',
            title: currentLanguage === 'ar' ? 'ŸÖÿÆÿßÿ∑ÿ± ÿ≥ŸäŸàŸÑÿ©' : 'Liquidity Risk',
            text: currentLanguage === 'ar'
                ? `ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿØÿßŸàŸÑ ${currentRatio.toFixed(2)} ÿ£ŸÇŸÑ ŸÖŸÜ 1ÿå ŸÖŸÖÿß Ÿäÿ¥Ÿäÿ± ÿ•ŸÑŸâ ÿµÿπŸàÿ®ÿßÿ™ ŸÖÿ≠ÿ™ŸÖŸÑÿ© ŸÅŸä ÿßŸÑÿ≥ŸäŸàŸÑÿ©.`
                : `Current ratio of ${currentRatio.toFixed(2)} below 1 indicates potential liquidity difficulties.`
        });
    }
    
    // Profitability insight
    const netMargin = (d.ratios.netMargin || 0) * 100;
    if (netMargin > 15) {
        insights.push({
            type: 'positive',
            title: currentLanguage === 'ar' ? 'ÿ±ÿ®ÿ≠Ÿäÿ© ŸÖŸÖÿ™ÿßÿ≤ÿ©' : 'Excellent Profitability',
            text: currentLanguage === 'ar'
                ? `ŸáÿßŸÖÿ¥ ÿµÿßŸÅŸä ÿßŸÑÿ±ÿ®ÿ≠ ${netMargin.toFixed(1)}% Ÿäÿ™ÿ¨ÿßŸàÿ≤ ŸÖÿπÿßŸäŸäÿ± ÿßŸÑÿµŸÜÿßÿπÿ©.`
                : `Net margin of ${netMargin.toFixed(1)}% exceeds industry benchmarks.`
        });
    } else if (netMargin < 5 && netMargin > 0) {
        insights.push({
            type: 'warning',
            title: currentLanguage === 'ar' ? 'ŸáÿßŸÖÿ¥ ÿ±ÿ®ÿ≠ ÿ∂ÿπŸäŸÅ' : 'Thin Margins',
            text: currentLanguage === 'ar'
                ? `ŸáÿßŸÖÿ¥ ÿµÿßŸÅŸä ÿßŸÑÿ±ÿ®ÿ≠ ${netMargin.toFixed(1)}% Ÿäÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ™ÿ≠ÿ≥ŸäŸÜ.`
                : `Net margin of ${netMargin.toFixed(1)}% needs improvement.`
        });
    }
    
    // NPV insight
    const npv = d.valuation.npv || 0;
    if (npv > 0) {
        insights.push({
            type: 'positive',
            title: currentLanguage === 'ar' ? 'ÿµÿßŸÅŸä ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ•Ÿäÿ¨ÿßÿ®Ÿä' : 'Positive NPV',
            text: currentLanguage === 'ar'
                ? `ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ Ÿäÿ∂ŸäŸÅ ŸÇŸäŸÖÿ© ŸÖÿπ NPV ŸÖŸàÿ¨ÿ® ÿ®ŸÇŸäŸÖÿ© ${formatCurrency(npv)}.`
                : `Project adds value with positive NPV of ${formatCurrency(npv)}.`
        });
    } else if (npv < 0) {
        insights.push({
            type: 'negative',
            title: currentLanguage === 'ar' ? 'ÿµÿßŸÅŸä ÿßŸÑŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿ≥ŸÑÿ®Ÿä' : 'Negative NPV',
            text: currentLanguage === 'ar'
                ? `ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ ŸÇÿØ ŸäÿØŸÖÿ± ÿßŸÑŸÇŸäŸÖÿ© ŸÖÿπ NPV ÿ≥ŸÑÿ®Ÿä.`
                : `Project may destroy value with negative NPV.`
        });
    }
    
    // Debt insight
    const debtToEquity = d.ratios.debtToEquity || 0;
    if (debtToEquity > 2) {
        insights.push({
            type: 'warning',
            title: currentLanguage === 'ar' ? 'ÿ±ŸÅÿπ ŸÖÿßŸÑŸä ÿπÿßŸÑŸä' : 'High Leverage',
            text: currentLanguage === 'ar'
                ? `ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿØŸäŸÜ ÿ•ŸÑŸâ ÿ≠ŸÇŸàŸÇ ÿßŸÑŸÖŸÑŸÉŸäÿ© ${debtToEquity.toFixed(2)} ÿ™ÿ¥Ÿäÿ± ÿ•ŸÑŸâ ŸÖÿÆÿßÿ∑ÿ± ÿ™ŸÖŸàŸäŸÑŸäÿ©.`
                : `Debt/Equity ratio of ${debtToEquity.toFixed(2)} indicates financing risks.`
        });
    }
    
    // Overall recommendation
    const rec = getRecommendation(totalScore);
    insights.push({
        type: 'info',
        title: currentLanguage === 'ar' ? 'ÿßŸÑÿ™ŸàÿµŸäÿ© ÿßŸÑÿπÿßŸÖÿ©' : 'Overall Recommendation',
        text: currentLanguage === 'ar'
            ? `ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿ¥ÿßŸÖŸÑÿå ÿßŸÑÿ™ŸàÿµŸäÿ© ŸáŸä: ${t[rec.type].toUpperCase()}`
            : `Based on comprehensive analysis, recommendation is: ${t[rec.type].toUpperCase()}`
    });
    
    return insights;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
    const t = translations[currentLanguage];
    const d = currentData;
    
    // Company Info
    document.getElementById('companyName').textContent = d.company.name || 'Company';
    document.getElementById('companyLogo').textContent = (d.company.name || 'C')[0].toUpperCase();
    document.getElementById('industryValue').textContent = d.company.industry || '-';
    document.getElementById('periodValue').textContent = d.company.period || '-';
    document.getElementById('currencyValue').textContent = d.company.currency || '-';
    document.getElementById('objectiveValue').textContent = d.company.objective || '-';
    
    renderInvestmentScore(t, d);
    renderOverview(t, d);
    renderHorizontal(t, d);
    renderVertical(t, d);
    renderRatios(t, d);
    renderValuation(t, d);
    renderDecision(t, d);
    renderMapping(t, d);
}

function renderInvestmentScore(t, d) {
    const { scores, totalScore } = calculateInvestmentScore(d);
    const recommendation = getRecommendation(totalScore);
    const insights = generateAIInsights(d, scores, totalScore);
    
    // Animate score gauge
    const gauge = document.getElementById('scoreGaugeFill');
    const circumference = 2 * Math.PI * 80;
    const offset = circumference - (totalScore / 100) * circumference;
    
    setTimeout(() => {
        gauge.style.strokeDashoffset = offset;
        gauge.style.stroke = recommendation.color;
    }, 100);
    
    // Animate score number
    const scoreEl = document.getElementById('investmentScoreValue');
    animateValue(scoreEl, 0, totalScore, 1000);
    scoreEl.style.color = recommendation.color;
    
    // Recommendation badge
    const badge = document.getElementById('recommendationBadge');
    badge.className = `recommendation-badge ${recommendation.type}`;
    document.getElementById('recommendationIcon').textContent = recommendation.icon;
    document.getElementById('recommendationText').textContent = t[recommendation.type].toUpperCase();
    
    // Score breakdown
    const breakdownItems = [
        { key: 'liquidityScore', value: scores.liquidity, max: 20, icon: 'üíß', class: 'liquidity' },
        { key: 'profitabilityScore', value: scores.profitability, max: 25, icon: 'üìà', class: 'profitability' },
        { key: 'leverageScore', value: scores.leverage, max: 20, icon: '‚öñÔ∏è', class: 'leverage' },
        { key: 'valuationScore', value: scores.valuation, max: 20, icon: 'üí∞', class: 'valuation' },
        { key: 'growthScore', value: scores.growth, max: 15, icon: 'üöÄ', class: 'growth' }
    ];
    
    document.getElementById('scoreBreakdownContent').innerHTML = breakdownItems.map(item => {
        const percent = (item.value / item.max) * 100;
        const color = percent >= 70 ? '#10b981' : percent >= 40 ? '#f59e0b' : '#ef4444';
        return `
            <div class="breakdown-item">
                <div class="breakdown-info">
                    <div class="breakdown-icon ${item.class}">${item.icon}</div>
                    <span class="breakdown-name">${t[item.key]}</span>
                </div>
                <div class="breakdown-score">
                    <span class="breakdown-value" style="color: ${color}">${item.value}/${item.max}</span>
                    <div class="breakdown-bar">
                        <div class="breakdown-bar-fill" style="width: ${percent}%; background: ${color}"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    // AI Insights
    document.getElementById('aiInsightsContent').innerHTML = insights.map(insight => `
        <div class="insight-item ${insight.type}">
            <div class="insight-title">
                ${insight.type === 'positive' ? '‚úÖ' : insight.type === 'negative' ? '‚ùå' : insight.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}
                ${insight.title}
            </div>
            <div class="insight-text">${insight.text}</div>
        </div>
    `).join('');
}

function animateValue(el, start, end, duration) {
    const startTime = performance.now();
    const update = (currentTime) => {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const easeOut = 1 - Math.pow(1 - progress, 3);
        el.textContent = Math.round(start + (end - start) * easeOut);
        if (progress < 1) requestAnimationFrame(update);
    };
    requestAnimationFrame(update);
}

function renderOverview(t, d) {
    const kpis = [
        { key: 'revenue', value: d.income.revenue, icon: 'üí∞', status: 'positive' },
        { key: 'netIncome', value: d.income.netIncome, icon: 'üìà', status: 'positive' },
        { key: 'totalAssets', value: d.balance.totalAssets, icon: 'üè¶', status: 'neutral' },
        { key: 'freeCashFlow', value: d.cashflow.freeCashFlow, icon: 'üíµ', status: d.cashflow.freeCashFlow > 0 ? 'positive' : 'negative' }
    ];
    
    document.getElementById('kpiGrid').innerHTML = kpis.map(kpi => `
        <div class="kpi-card ${kpi.status}">
            <div class="kpi-header">
                <span class="kpi-label">${t[kpi.key] || kpi.key}</span>
                <span class="kpi-icon">${kpi.icon}</span>
            </div>
            <div class="kpi-value">${formatCurrency(kpi.value)}</div>
        </div>
    `).join('');
    
    document.getElementById('incomeGrid').innerHTML = renderStatementItems([
        { key: 'revenue', value: d.income.revenue },
        { key: 'cogs', value: d.income.cogs },
        { key: 'operatingExpenses', value: d.income.operatingExpenses },
        { key: 'ebit', value: d.income.ebit },
        { key: 'netIncome', value: d.income.netIncome }
    ], t);
    
    document.getElementById('balanceGrid').innerHTML = renderStatementItems([
        { key: 'currentAssets', value: d.balance.currentAssets },
        { key: 'totalAssets', value: d.balance.totalAssets },
        { key: 'currentLiabilities', value: d.balance.currentLiabilities },
        { key: 'totalLiabilities', value: d.balance.totalLiabilities },
        { key: 'equity', value: d.balance.equity },
        { key: 'totalDebt', value: d.balance.totalDebt }
    ], t);
    
    document.getElementById('cashflowGrid').innerHTML = renderStatementItems([
        { key: 'operatingCashFlow', value: d.cashflow.operatingCashFlow },
        { key: 'capex', value: d.cashflow.capex },
        { key: 'freeCashFlow', value: d.cashflow.freeCashFlow }
    ], t);
    
    document.getElementById('assumptionsGrid').innerHTML = renderStatementItems([
        { key: 'taxRate', value: d.assumptions.taxRate, isPercent: true },
        { key: 'costOfDebt', value: d.assumptions.costOfDebt, isPercent: true },
        { key: 'costOfEquity', value: d.assumptions.costOfEquity, isPercent: true },
        { key: 'wacc', value: d.assumptions.wacc, isPercent: true }
    ], t);
}

function renderStatementItems(items, t) {
    return items.map(item => `
        <div class="statement-item">
            <span class="item-label">${t[item.key] || item.key}</span>
            <span class="item-value">${item.isPercent ? formatPercent(item.value) : formatCurrency(item.value)}</span>
        </div>
    `).join('');
}

function renderHorizontal(t, d) {
    if (d.horizontal.length === 0) return;
    
    document.getElementById('horizontalTableHead').innerHTML = `
        <th>${t.vItemHeader}</th><th>2024</th><th>2023</th><th>${currentLanguage === 'ar' ? 'ÿßŸÑÿ™ÿ∫ŸäŸäÿ± %' : 'Change %'}</th>
    `;
    document.getElementById('horizontalTableBody').innerHTML = d.horizontal.map(row => `
        <tr>
            <td>${t[row.item] || row.item}</td>
            <td>${formatCurrency(row.y2024)}</td>
            <td>${formatCurrency(row.y2023)}</td>
            <td class="${row.change >= 0 ? 'positive' : 'negative'}">${formatPercent(row.change)}</td>
        </tr>
    `).join('');
    
    renderHorizontalChart(d.horizontal, t);
}

function renderVertical(t, d) {
    if (d.vertical.length === 0) return;
    
    document.getElementById('verticalTableBody').innerHTML = d.vertical.map(row => `
        <tr>
            <td>${t[row.item.toLowerCase()] || row.item}</td>
            <td>${formatPercent(row.percent)}</td>
            <td>${getInterpretation(row.item, row.percent, t)}</td>
        </tr>
    `).join('');
    
    renderVerticalChart(d.vertical, t);
}

function renderRatios(t, d) {
    const ratioGroups = [
        { class: 'liquidity', title: t.liquidity, ratios: [
            { key: 'currentRatio', value: d.ratios.currentRatio, benchmark: 1.5 },
            { key: 'quickRatio', value: d.ratios.quickRatio, benchmark: 1.0 }
        ]},
        { class: 'profitability', title: t.profitability, ratios: [
            { key: 'netMargin', value: d.ratios.netMargin, benchmark: 0.1, isPercent: true },
            { key: 'roa', value: d.ratios.roa, benchmark: 0.05, isPercent: true },
            { key: 'roe', value: d.ratios.roe, benchmark: 0.15, isPercent: true }
        ]},
        { class: 'leverage', title: t.leverage, ratios: [
            { key: 'debtToEquity', value: d.ratios.debtToEquity, benchmark: 1.5, inverse: true }
        ]}
    ];
    
    document.getElementById('ratioCategories').innerHTML = ratioGroups.map(group => `
        <div class="ratio-category ${group.class}">
            <div class="ratio-category-header">${group.title}</div>
            <div class="ratio-list">
                ${group.ratios.map(r => `
                    <div class="ratio-item">
                        <span class="ratio-name">${t[r.key] || r.key}</span>
                        <span class="ratio-value ${getRatioStatus(r.value, r.benchmark, r.inverse)}">
                            ${r.isPercent ? formatPercent(r.value) : formatRatio(r.value)}
                        </span>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
    
    renderRatioChart(d.ratios, t);
}

function renderValuation(t, d) {
    const cards = [
        { title: 'NPV', value: formatCurrency(d.valuation.npv), details: [
            { label: t.wacc, value: formatPercent(d.assumptions.wacc) },
            { label: t.freeCashFlow, value: formatCurrency(d.cashflow.freeCashFlow) }
        ]},
        { title: 'IRR', value: d.valuation.irr === '#NUM!' ? 'N/A' : formatPercent(d.valuation.irr), details: [
            { label: 'Status', value: d.valuation.irr === '#NUM!' ? 'Calculation Error' : 'Computed' }
        ]},
        { title: 'WACC', value: formatPercent(d.assumptions.wacc), details: [
            { label: t.costOfEquity, value: formatPercent(d.assumptions.costOfEquity) },
            { label: t.costOfDebt, value: formatPercent(d.assumptions.costOfDebt) }
        ]}
    ];
    
    document.getElementById('valuationGrid').innerHTML = cards.map(card => `
        <div class="valuation-card">
            <div class="valuation-card-header"><h4>${card.title}</h4></div>
            <div class="valuation-card-body">
                <div class="valuation-main-value">${card.value}</div>
                <ul class="valuation-details">
                    ${card.details.map(d => `<li><span class="detail-label">${d.label}</span><span class="detail-value">${d.value}</span></li>`).join('')}
                </ul>
            </div>
        </div>
    `).join('');
    
    document.getElementById('capmNotes').innerHTML = `<p style="white-space: pre-line; color: var(--text-secondary);">${d.valuation.capmNotes || 'No CAPM notes available.'}</p>`;
}

function renderDecision(t, d) {
    const blocks = [
        { title: t.executiveSummary, content: d.decision.summary, icon: 'üìã' },
        { title: t.keyFindings, content: d.decision.findings, icon: 'üîç' },
        { title: t.investmentEvaluation, content: d.decision.evaluation, icon: 'üìä' }
    ];
    
    const isPositive = d.decision.final.toLowerCase().includes('acceptable') || d.decision.final.toLowerCase().includes('ŸÖŸÇÿ®ŸàŸÑ');
    
    document.getElementById('decisionBody').innerHTML = `
        ${blocks.map(b => `
            <div class="decision-block">
                <h4>${b.icon} ${b.title}</h4>
                <p>${b.content || 'No data available.'}</p>
            </div>
        `).join('')}
        <div class="final-verdict ${isPositive ? '' : 'negative-verdict'}">
            <div class="verdict-label">${t.finalDecision}</div>
            <div class="verdict-text">${d.decision.final || 'No final decision provided.'}</div>
        </div>
    `;
}

function renderMapping(t, d) {
    const found = d.mapping.found.length;
    const missing = 25 - found;
    
    document.getElementById('mappingStats').innerHTML = `
        <div class="stat-box found"><div class="stat-number">${found}</div><div class="stat-label">${t.found}</div></div>
        <div class="stat-box missing"><div class="stat-number">${missing}</div><div class="stat-label">${t.missing}</div></div>
    `;
    
    document.getElementById('mappingGrid').innerHTML = d.mapping.found.map(item => `
        <div class="mapping-item found"><span class="mapping-status">‚úì</span><span class="mapping-label">${item}</span></div>
    `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getChartColors() {
    const isDark = currentTheme === 'dark';
    return {
        text: isDark ? '#f1f5f9' : '#1e293b',
        grid: isDark ? '#334155' : '#e2e8f0'
    };
}

function updateChartsTheme() {
    const colors = getChartColors();
    Object.values(charts).forEach(chart => {
        if (chart && chart.options) {
            if (chart.options.scales) {
                Object.values(chart.options.scales).forEach(scale => {
                    scale.ticks = scale.ticks || {};
                    scale.ticks.color = colors.text;
                    scale.grid = scale.grid || {};
                    scale.grid.color = colors.grid;
                });
            }
            if (chart.options.plugins && chart.options.plugins.legend) {
                chart.options.plugins.legend.labels = chart.options.plugins.legend.labels || {};
                chart.options.plugins.legend.labels.color = colors.text;
            }
            chart.update();
        }
    });
}

function renderHorizontalChart(data, t) {
    const ctx = document.getElementById('horizontalChart').getContext('2d');
    if (charts.horizontal) charts.horizontal.destroy();
    const colors = getChartColors();
    
    charts.horizontal = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => t[d.item] || d.item),
            datasets: [
                { label: '2024', data: data.map(d => d.y2024), backgroundColor: 'rgba(49, 130, 206, 0.8)' },
                { label: '2023', data: data.map(d => d.y2023), backgroundColor: 'rgba(99, 179, 237, 0.8)' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: colors.text } } },
            scales: {
                x: { ticks: { color: colors.text }, grid: { color: colors.grid } },
                y: { ticks: { color: colors.text }, grid: { color: colors.grid } }
            }
        }
    });
}

function renderVerticalChart(data, t) {
    const ctx = document.getElementById('verticalChart').getContext('2d');
    if (charts.vertical) charts.vertical.destroy();
    const colors = getChartColors();
    
    charts.vertical = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(d => t[d.item.toLowerCase()] || d.item),
            datasets: [{ data: data.map(d => Math.abs(d.percent) * 100), backgroundColor: ['#ef4444', '#f59e0b', '#10b981', '#3b82f6'] }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: colors.text } } }
        }
    });
}

function renderRatioChart(ratios, t) {
    const ctx = document.getElementById('ratioChart').getContext('2d');
    if (charts.ratio) charts.ratio.destroy();
    const colors = getChartColors();
    
    const labels = [t.currentRatio, t.quickRatio, t.netMargin, t.roa, t.roe, t.debtToEquity];
    const values = [ratios.currentRatio, ratios.quickRatio, (ratios.netMargin || 0) * 100, (ratios.roa || 0) * 100, (ratios.roe || 0) * 100, ratios.debtToEquity];
    
    charts.ratio = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{ label: currentLanguage === 'ar' ? 'ÿßŸÑŸÇŸäŸÖÿ©' : 'Value', data: values, backgroundColor: ['#3b82f6', '#3b82f6', '#10b981', '#10b981', '#10b981', '#f59e0b'] }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: { legend: { labels: { color: colors.text } } },
            scales: {
                x: { ticks: { color: colors.text }, grid: { color: colors.grid } },
                y: { ticks: { color: colors.text }, grid: { color: colors.grid } }
            }
        }
    });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatCurrency(value) {
    if (value === null || value === undefined) return '-';
    const symbol = currencySymbols[currentCurrency];
    const converted = value * (exchangeRates[currentCurrency] / exchangeRates.USD);
    return `${symbol}${converted.toLocaleString('en-US', { maximumFractionDigits: 0 })}`;
}

function formatPercent(value) {
    if (value === null || value === undefined) return '-';
    const pct = value < 1 && value > -1 ? value * 100 : value;
    return `${pct.toFixed(2)}%`;
}

function formatRatio(value) {
    if (value === null || value === undefined) return '-';
    return value.toFixed(2);
}

function getRatioStatus(value, benchmark, inverse = false) {
    if (value === null) return '';
    if (inverse) return value < benchmark ? 'good' : value < benchmark * 1.5 ? 'warning' : 'bad';
    return value >= benchmark ? 'good' : value >= benchmark * 0.5 ? 'warning' : 'bad';
}

function getInterpretation(item, value, t) {
    if (item === 'COGS') return value > 0.5 ? (currentLanguage === 'ar' ? 'ŸÖÿ±ÿ™ŸÅÿπ' : 'High') : (currentLanguage === 'ar' ? 'ŸÖŸÇÿ®ŸàŸÑ' : 'Acceptable');
    if (item === 'Net Income') return value > 0.2 ? (currentLanguage === 'ar' ? 'ŸÖŸÖÿ™ÿßÿ≤' : 'Excellent') : (currentLanguage === 'ar' ? 'ÿ¨ŸäÿØ' : 'Good');
    return currentLanguage === 'ar' ? 'ÿπÿßÿØŸä' : 'Normal';
}
</script>
</body>
</html>
